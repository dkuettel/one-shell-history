#!/usr/bin/env zsh
set -eu -o pipefail

export mode=${1:-all}  # - to select a mode, or: all, session, folder, bag
export query=${2:-}  # TODO query is not carried over when switching modes, escaping is a bit difficult
[[ ! -v 3 ]]

# TODO not sure yet how to pass those, shell is not the best for this
export session=2e715f13-1248-443f-ae0f-65d315ae9b18
export folder=/home/dkuettel

style=(
    --height=70%
    --min-height=10
    --info=inline-right
    --highlight-line
    --preview-window=down:10:wrap
    # NOTE --no-clear could be interesting, but flickering is not so bad now
)

if [[ $mode == - ]]; then
    args=(
        --delimiter=' '
        --with-nth=1
        --preview='print -- {2..}'
    )
    (
        print -- 'all search in all of history, forever, always.'
        print -- 'session search in the current session only'
        print -- 'folder search in the current folder only'
        print -- 'bag search an aggregated view of all unique commands in all of history, forever, always.'
    ) | fzf $style $args --bind='enter:become:draft {1}'
fi

args=(
    --prompt="$mode> "
    --query=$query
    --tiebreak=index
    --scheme=history
    --read0
    --delimiter=\\x1f
    --with-nth=3..
    --nth=2..
    --preview='echo {2} | base64 --decode'
    --print0
    --print-query
    --bind 'start:reload:uv run -- python -m draft search --mode=$mode --session=$session --folder=$folder'
    --bind 'enter:become:echo {1} | base64 --decode'
    --bind 'tab:become:draft -'
)
fzf $style $args
