#!/bin/zsh
set -eux -o pipefail

# install into systemd, idempotent
# for the current user (dont run with sudo)

if [[ $USER == 'root' ]]; then
    echo 'not meant to be installed as a service for user root'
    exit 1
fi

export base=${0:a:h}
cat $base/one-shell-history@.service \
    | envsubst \
    | sudo tee /etc/systemd/system/one-shell-history@$USER.service

# TODO daemon-reload doesnt seem to be necessary,
# it worked for me when both the service file was new or when it was changed
#sudo systemctl daemon-reload

if ! sudo systemctl enable --now --wait one-shell-history@$USER.service; then
    sudo systemctl status --no-pager --full one-shell-history@$USER.service
fi
