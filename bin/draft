#!/bin/zsh
set -eu -o pipefail

# args=(
#     --height=70%
#     --min-height=10
#     --header-lines=1
#     --query=${1:-}
#     --tiebreak=index
#     --scheme=history
#     # TODO --tac for reverse?
#     --read0
#     --info=inline-right
#     --highlight-line
#     --delimiter=\\x1f
#     --with-nth=2..
#     --nth=2..
#     --preview-window=down:10:wrap
#     --preview='python -m draft get-preview {1}'
#     --print0
#     --print-query
#     # TODO use the actual session id
#     --bind 'start:execute-silent(python -m draft serve --session=2e715f13-1248-443f-ae0f-65d315ae9b18 &)+reload(python -m draft list-events)'
#     --bind 'enter:become(python -m draft exit --index {1})'
#     --bind 'esc:become(python -m draft exit --fail)'
#     --bind 'ctrl-c:become(python -m draft exit --fail)'
#     --bind 'tab:reload(python -m draft list-events --mode=next)'
#     --bind 'shift-tab:reload(python -m draft list-events --mode=previous)'
# )
# unshare -r -n fzf $args

# export modes=${modes:-reverse-global reverse-session}
# export mode=${mode:-reverse-global}

args=(
    --height=70%
    --min-height=10
    # --header-lines=1
    --query=${1:-}
    --tiebreak=index
    --scheme=history
    # TODO --tac for reverse?
    --read0
    --info=inline-right
    --highlight-line
    --delimiter=\\x1f
    --with-nth=4..
    --nth=2..
    --preview-window=down:10:wrap
    --preview='echo {3} | base64 --decode'
    --print0
    --print-query
    # TODO use the actual session id
    # TODO pass session, folder, and other stuff via env of args?
    --bind 'start:reload(python -m draft search --session=2e715f13-1248-443f-ae0f-65d315ae9b18 --folder=/home/dkuettel)'
    --bind 'enter:become(echo {2} | base64 --decode)'
    --bind 'tab:reload(python -m draft search --mode-after={1} --session=2e715f13-1248-443f-ae0f-65d315ae9b18 --folder=/home/dkuettel)'
    --bind 'shift-tab:reload(python -m draft search --mode-before={1} --session=2e715f13-1248-443f-ae0f-65d315ae9b18 --folder=/home/dkuettel)'
)
fzf $args
